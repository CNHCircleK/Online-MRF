var mongo = require('mongodb');
var ObjectId = mongo.ObjectId;
var mongoSanitize = require('express-mongo-sanitize');

module.exports = function(app){
	return {
		allIn: function(json, fields){
			var allPresent = true;
			fields.forEach(function(elem){
				if(!(elem in json)){
					allPresent = false;
					return false;
				} 
			});
			return allPresent;
		},

		createNew: function(collection, data, parentCollection, parentId, callback = function(){}){
			if(!ObjectId.isValid(parentId)){
				callback(null, false);
				return;
			}

			var query = {"_id": ObjectId(parentId)};
			var newId = ObjectId();
			var obj = {};
			obj[collection] = newId;
			var changes = {$push: obj};

			app.db.collection(parentCollection).updateOne(query, changes, function(err, res){
				if(err){
					callback(err);
					return;
				}
				console.log(changes);
				console.log(query);
				console.log(res);
				if(res.matchedCount > 0){
					data["_id"] = newId;
					app.db.collection(collection).insertOne(mongoSanitize.sanitize(data), function(err, res){
						if(err){
							callback(err);
							return;
						}

						callback(null, true);
					});
				}else{
					callback(null, false);
					return;
				}
			});
		}
	}
}